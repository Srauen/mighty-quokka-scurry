<!DOCTYPE html>
<html lang="en" class="h-full w-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0f17;
            background-image: radial-gradient(circle at center, #1a2033 0%, #0d0f17 100%);
            color: #d1d5db;
            overflow: hidden;
            user-select: none;
        }
        .boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d0f17;
            background-image: radial-gradient(circle at center, #1a2033 0%, #0d0f17 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .boot-logo {
            animation: bounceIn 1s ease-out;
        }
        .boot-progress-bar {
            width: 200px;
            height: 4px;
            background-color: #374151;
            margin-top: 1.5rem;
            border-radius: 9999px;
            overflow: hidden;
        }
        .boot-progress {
            height: 100%;
            width: 0%;
            background-color: #4f46e5;
            transition: width 1s ease-in-out;
        }
        .window {
            position: absolute;
            background-color: #1a2033;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
        }
        .window-header {
            cursor: grab;
        }
        .window-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: transparent;
        }
        .top-left { top: 0; left: 0; cursor: nw-resize; }
        .top-right { top: 0; right: 0; cursor: ne-resize; }
        .bottom-left { bottom: 0; left: 0; cursor: sw-resize; }
        .bottom-right { bottom: 0; right: 0; cursor: se-resize; }
        .bottom-center { bottom: 0; left: 50%; transform: translateX(-50%); cursor: s-resize; width: 50%; height: 10px; }
        .top-center { top: 0; left: 50%; transform: translateX(-50%); cursor: n-resize; width: 50%; height: 10px; }
        .left-center { left: 0; top: 50%; transform: translateY(-50%); cursor: w-resize; height: 50%; width: 10px; }
        .right-center { right: 0; top: 50%; transform: translateY(-50%); cursor: e-resize; height: 50%; width: 10px; }
        .start-menu {
            transition: all 0.2s ease-in-out;
            transform-origin: bottom left;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .start-menu.show {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .window-content::-webkit-scrollbar { width: 8px; }
        .window-content::-webkit-scrollbar-track { background: #2d3748; }
        .window-content::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 4px; }
        .window-content::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        .taskbar-item {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 44px;
            height: 44px;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            margin: 0 4px;
            position: relative;
        }
        .taskbar-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .taskbar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
            transform: translateY(-2px);
        }
        .taskbar-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            width: 4px;
            height: 4px;
            background-color: #4f46e5;
            border-radius: 9999px;
            box-shadow: 0 0 4px #4f46e5;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            75% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .window-content, .trading-log, .news-feed {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .window-content::-webkit-scrollbar, .trading-log::-webkit-scrollbar, .news-feed::-webkit-scrollbar {
            width: 8px;
        }
        .window-content::-webkit-scrollbar-track, .trading-log::-webkit-scrollbar-track, .news-feed::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .window-content::-webkit-scrollbar-thumb, .trading-log::-webkit-scrollbar-thumb, .news-feed::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        #stock-os-title {
            transition: all 1s ease-out;
        }
    </style>
</head>
<body class="h-full w-full">

    <!-- Boot Audio -->
    <audio id="boot-audio" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-up-1854.mp3" type="audio/mp3">
    </audio>

    <!-- Boot Screen -->
    <div id="boot-screen" class="boot-screen">
        <div class="boot-logo flex flex-col items-center justify-center">
            <svg class="w-16 h-16 text-indigo-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 22h20L12 2zm0 14a2 2 0 100-4 2 2 0 000 4z"/>
            </svg>
            <p class="text-indigo-400 text-3xl font-bold mt-4">Stock OS</p>
        </div>
        <div class="boot-progress-bar">
            <div id="boot-progress" class="boot-progress"></div>
        </div>
    </div>

    <!-- Desktop -->
    <div id="desktop" class="hidden h-full w-full flex flex-col p-4 bg-transparent transition-all duration-500">
        <div class="flex-grow flex flex-col items-center justify-center relative">
            <h1 id="stock-os-title" class="text-4xl sm:text-6xl font-extrabold text-white text-shadow-lg animate-pulse-slow">Stock OS</h1>
            <div class="absolute top-4 right-4 bg-gray-900 bg-opacity-75 backdrop-blur-lg px-4 py-2 rounded-lg text-sm font-medium">
                Cash Balance: <span id="cash-balance" class="text-green-400">$10,000.00</span>
            </div>
        </div>
        
        <!-- Stock Chart Window -->
        <div id="stock-chart-window" class="window top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[70vw] h-[70vh] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Stock Chart</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('stock-chart-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('stock-chart-window')"></button>
                </div>
            </div>
            <div class="window-content flex-grow p-4 overflow-y-auto">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="stock-select" class="block text-sm font-medium mb-1">Select a Stock</label>
                        <select id="stock-select" class="w-full p-2 bg-[#2d3748] text-white rounded-md border border-[#4a5568]">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="relative w-full h-80">
                    <canvas id="stock-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Trading Terminal Window -->
        <div id="trading-terminal-window" class="window top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-[50vw] h-[60vh] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Trading Terminal</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('trading-terminal-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('trading-terminal-window')"></button>
                </div>
            </div>
            <div class="window-content flex-grow p-4 overflow-y-auto">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="terminal-stock-select" class="block text-sm font-medium mb-1">Stock</label>
                        <select id="terminal-stock-select" class="w-full p-2 bg-[#2d3748] rounded-md border border-[#4a5568]">
                        </select>
                    </div>
                    <div class="flex-grow">
                        <label for="terminal-quantity" class="block text-sm font-medium mb-1">Quantity</label>
                        <input id="terminal-quantity" type="number" value="1" min="1" class="w-full p-2 bg-[#2d3748] rounded-md border border-[#4a5568]">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="executeTrade('buy')" class="flex-grow py-3 bg-green-600 rounded-md hover:bg-green-700 font-bold">Buy</button>
                    <button onclick="executeTrade('sell')" class="flex-grow py-3 bg-red-600 rounded-md hover:bg-red-700 font-bold">Sell</button>
                </div>
                <div id="trading-log" class="mt-4 p-4 bg-[#2d3748] rounded-lg h-full overflow-y-auto">
                    <p class="text-gray-400 text-sm">Trading Log...</p>
                </div>
            </div>
        </div>

        <!-- Tor Browser Window -->
        <div id="tor-browser-window" class="window top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[80vw] h-[80vh] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Tor Browser</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('tor-browser-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('tor-browser-window')"></button>
                </div>
            </div>
            <div class="window-content flex-grow flex flex-col p-2 bg-[#1a2033]">
                <div class="flex items-center space-x-2 mb-2">
                    <input id="tor-url-input" type="text" placeholder="https://example.com" class="flex-grow p-2 rounded-md bg-[#2d3748] text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="loadTorPage()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors duration-200">Go</button>
                </div>
                <div class="bg-yellow-700 text-yellow-100 p-2 rounded-md text-sm mb-2">
                    <p>Note: This is a simulated browser. It does not provide real Tor network anonymity or security.</p>
                </div>
                <iframe id="tor-iframe" src="about:blank" class="flex-grow bg-white rounded-md border border-[#4a5568]"></iframe>
            </div>
        </div>

        <!-- Portfolio Window -->
        <div id="portfolio-window" class="window top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[70vw] h-[70vh] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Portfolio Manager</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('portfolio-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('portfolio-window')"></button>
                </div>
            </div>
            <div class="window-content flex-grow p-4 overflow-y-auto">
                <div class="bg-[#2d3748] p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">My Portfolio</h3>
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-600">
                                <th class="py-2">Stock</th>
                                <th class="py-2">Quantity</th>
                                <th class="py-2">Last Price</th>
                                <th class="py-2">Current Value</th>
                                <th class="py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="portfolio-table-body">
                            <!-- Portfolio items go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- News Window -->
        <div id="news-window" class="window top-1/2 right-4 -translate-y-1/2 w-[400px] h-[60vh] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Live News Feed</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('news-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('news-window')"></button>
                </div>
            </div>
            <div id="news-feed" class="window-content flex-grow p-4 overflow-y-auto space-y-4">
                <!-- News items go here -->
            </div>
        </div>

        <!-- Calculator Window -->
        <div id="calculator-window" class="window top-1/2 left-4 -translate-y-1/2 w-[300px] h-[400px] flex flex-col z-20 hidden">
            <div class="window-header flex justify-between items-center p-3 bg-[#2d3748] rounded-t-lg">
                <span class="text-sm font-semibold">Calculator</span>
                <div class="flex space-x-2">
                    <button class="w-3 h-3 bg-yellow-500 rounded-full hover:bg-yellow-400" onclick="hideWindow('calculator-window')"></button>
                    <button class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400" onclick="closeWindow('calculator-window')"></button>
                </div>
            </div>
            <div class="window-content flex-grow p-4 flex flex-col justify-end items-center">
                <div class="w-full bg-[#2d3748] rounded-md p-4 mb-4 text-right overflow-x-auto text-xl font-bold">
                    <div id="calc-display" class="text-white min-h-[1.5em]">0</div>
                </div>
                <div class="grid grid-cols-4 gap-2 w-full">
                    <button onclick="clearCalc()" class="col-span-2 px-4 py-4 bg-gray-600 rounded-md hover:bg-gray-700">C</button>
                    <button onclick="appendOperator('/')" class="px-4 py-4 bg-orange-500 rounded-md hover:bg-orange-600">/</button>
                    <button onclick="appendOperator('*')" class="px-4 py-4 bg-orange-500 rounded-md hover:bg-orange-600">x</button>
                    <button onclick="appendNumber('7')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">7</button>
                    <button onclick="appendNumber('8')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">8</button>
                    <button onclick="appendNumber('9')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">9</button>
                    <button onclick="appendOperator('-')" class="px-4 py-4 bg-orange-500 rounded-md hover:bg-orange-600">-</button>
                    <button onclick="appendNumber('4')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">4</button>
                    <button onclick="appendNumber('5')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">5</button>
                    <button onclick="appendNumber('6')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">6</button>
                    <button onclick="appendOperator('+')" class="px-4 py-4 bg-orange-500 rounded-md hover:bg-orange-600">+</button>
                    <button onclick="appendNumber('1')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">1</button>
                    <button onclick="appendNumber('2')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">2</button>
                    <button onclick="appendNumber('3')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">3</button>
                    <button onclick="calculateResult()" class="px-4 py-4 bg-orange-500 rounded-md hover:bg-orange-600 row-span-2">=</button>
                    <button onclick="appendNumber('0')" class="col-span-2 px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">0</button>
                    <button onclick="appendNumber('.')" class="px-4 py-4 bg-gray-700 rounded-md hover:bg-gray-800">.</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Taskbar -->
    <div id="taskbar" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 w-fit h-16 bg-gray-900 bg-opacity-75 backdrop-blur-lg flex items-center px-2 py-1 rounded-2xl shadow-lg z-40">
        <div id="taskbar-apps" class="flex items-center justify-center space-x-2">
            <!-- App icons go here -->
            <button onclick="openWindow('stock-chart-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 14v-4h-4v4h4zm-4-6V4H8v4h4zm8 0V4h-4v4h4zM8 18v-4H4v4h4zm8 0v-4h-4v4h4zM20 18v-4h-4v4h4z"/>
                </svg>
            </button>
            <button onclick="openWindow('trading-terminal-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm2-8h-2V7h2v2z"/>
                </svg>
            </button>
            <button onclick="openWindow('tor-browser-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-12v6h2v-6h-2zM14 8h-2v6h2V8z"/>
                </svg>
            </button>
            <button onclick="openWindow('portfolio-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm-2-10h4v2h-4V8zM12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5z"/>
                </svg>
            </button>
            <button onclick="openWindow('news-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12s4.48 10 10 10 10-4.48 10-10zM4 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8-8-3.59-8-8zm9.5-3h-2v4h4v-2h-2V9z"/>
                </svg>
            </button>
            <button onclick="openWindow('calculator-window')" class="taskbar-item">
                <svg class="w-7 h-7 text-pink-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6V5h12v14zM8 7h2v2H8zm4 0h2v2h-2zm4 0h2v2h-2zM8 11h2v2H8zm4 0h2v2h-2zm4 0h2v2h-2zM8 15h2v2H8zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-6 rounded-lg shadow-2xl z-50 transform scale-0 opacity-0 transition-all duration-300">
        <h3 id="message-title" class="text-xl font-bold mb-2 text-white"></h3>
        <p id="message-content" class="text-gray-300 mb-4"></p>
        <button onclick="hideMessageBox()" class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md">OK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId;
        let stockChart, stockData = {};
        let portfolio = {}; // Stores user's portfolio data
        let cashBalance = 10000; // Starting cash balance
        const cashBalanceEl = document.getElementById('cash-balance');
        let newsHeadlines = [
            "Market volatility expected after global events.",
            "Tech stocks surge on strong Q3 reports.",
            "Energy sector sees gains as oil prices stabilize.",
            "Inflation concerns lead to interest rate hike speculation.",
            "Analyst predicts strong year for renewable energy.",
            "Major companies announce stock buyback programs.",
            "New trade agreements could impact commodities.",
            "Retail sector reports mixed holiday sales.",
            "Cryptocurrency market shows signs of recovery.",
            "Pharmaceutical stock rallies on new drug approval."
        ];

        const stocksList = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'AMZN', 'NVDA', 'FB', 'NFLX', 'BABA', 'SBUX', 'KO', 'PEP', 'MCD', 'DIS', 'NKE', 'ADDYY', 'V', 'JPM', 'XOM', 'WMT', 'PG', 'MA', 'INTC', 'CSCO', 'CMCSA', 'PFE', 'T', 'VZ', 'CVX', 'HD', 'BA', 'MCO', 'BNS', 'RY', 'TD'];
        const stockSelect = document.getElementById('stock-select');
        const portfolioSelect = document.getElementById('portfolio-stock-select');
        const terminalStockSelect = document.getElementById('terminal-stock-select');
        const newsFeed = document.getElementById('news-feed');
        const tradingLog = document.getElementById('trading-log');
        
        const windows = {};
        const activeZIndex = 30;
        let currentCalcInput = '0';
        let previousCalcInput = '';
        let currentOperator = null;

        window.showMessageBox = function(title, message) {
            const box = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = message;
            box.classList.remove('scale-0', 'opacity-0');
            box.classList.add('scale-100', 'opacity-100');
        }

        window.hideMessageBox = function() {
            const box = document.getElementById('message-box');
            box.classList.remove('scale-100', 'opacity-100');
            box.classList.add('scale-0', 'opacity-0');
        }

        // Window management functions
        function registerWindow(id) {
            const element = document.getElementById(id);
            if (!element) return;
            windows[id] = { element: element, minimized: false, zIndex: 20 };
            makeWindowDraggableAndResizable(id);
        }

        window.openWindow = function(id) {
            const win = windows[id];
            if (win) {
                win.element.classList.remove('hidden');
                bringWindowToFront(id);
                win.minimized = false;
                updateTaskbar();
            }
        }
        
        function bringWindowToFront(id) {
            for (const winId in windows) {
                if (winId === id) {
                    windows[winId].element.style.zIndex = activeZIndex;
                } else {
                    windows[winId].element.style.zIndex = windows[winId].zIndex;
                }
            }
        }

        window.closeWindow = function(id) {
            const win = windows[id];
            if (win) {
                win.element.classList.add('hidden');
                win.minimized = false;
                updateTaskbar();
            }
        }

        window.hideWindow = function(id) {
            const win = windows[id];
            if (win) {
                win.element.classList.add('hidden');
                win.minimized = true;
                updateTaskbar();
            }
        }

        function updateTaskbar() {
            // Update active state of buttons
            const taskbarItems = document.querySelectorAll('.taskbar-item');
            taskbarItems.forEach(button => {
                const windowId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (windows[windowId] && !windows[windowId].element.classList.contains('hidden')) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function makeWindowDraggableAndResizable(id) {
            const win = document.getElementById(id);
            const header = win.querySelector('.window-header');
            const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right', 'top-center', 'bottom-center', 'left-center', 'right-center'];
            handles.forEach(h => {
                const handle = document.createElement('div');
                handle.className = `window-handle ${h}`;
                win.appendChild(handle);
                setupResize(win, handle, h);
            });

            header.addEventListener('mousedown', (e) => {
                const offsetX = e.clientX - win.offsetLeft;
                const offsetY = e.clientY - win.offsetTop;
                bringWindowToFront(id);

                function moveWindow(e) {
                    win.style.left = `${e.clientX - offsetX}px`;
                    win.style.top = `${e.clientY - offsetY}px`;
                }

                function stopMoving() {
                    document.removeEventListener('mousemove', moveWindow);
                    document.removeEventListener('mouseup', stopMoving);
                    header.style.cursor = 'grab';
                }

                document.addEventListener('mousemove', moveWindow);
                document.addEventListener('mouseup', stopMoving);
                header.style.cursor = 'grabbing';
            });
        }
        
        function setupResize(win, handle, direction) {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = win.offsetWidth;
                const startHeight = win.offsetHeight;
                const startLeft = win.offsetLeft;
                const startTop = win.offsetTop;
                bringWindowToFront(id);

                function resizeWindow(e) {
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;

                    if (direction.includes('right')) {
                        newWidth = startWidth + (e.clientX - startX);
                    }
                    if (direction.includes('left')) {
                        newWidth = startWidth - (e.clientX - startX);
                        newLeft = startLeft + (e.clientX - startX);
                    }
                    if (direction.includes('bottom')) {
                        newHeight = startHeight + (e.clientY - startY);
                    }
                    if (direction.includes('top')) {
                        newHeight = startHeight - (e.clientY - startY);
                        newTop = startTop + (e.clientY - startY);
                    }

                    win.style.width = `${newWidth}px`;
                    win.style.height = `${newHeight}px`;
                    win.style.left = `${newLeft}px`;
                    win.style.top = `${newTop}px`;
                    updateChart();
                }
                
                function stopResizing() {
                    document.removeEventListener('mousemove', resizeWindow);
                    document.removeEventListener('mouseup', stopResizing);
                    win.style.cursor = 'default';
                }
                
                document.addEventListener('mousemove', resizeWindow);
                document.addEventListener('mouseup', stopResizing);
            });
        }

        // Charting logic
        function createChart(stock) {
            const ctx = document.getElementById('stock-chart').getContext('2d');
            if (stockChart) {
                stockChart.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stockData[stock].labels,
                    datasets: [{
                        label: `${stock} Price`,
                        data: stockData[stock].prices,
                        borderColor: '#4f46e5',
                        backgroundColor: gradient,
                        pointBackgroundColor: '#4f46e5',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4f46e5',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#374151' },
                            ticks: { color: '#d1d5db' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#d1d5db' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1f2937',
                            titleColor: '#fff',
                            bodyColor: '#d1d5db',
                            borderColor: '#4f46e5',
                            borderWidth: 1,
                            cornerRadius: 6,
                            padding: 10,
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            right: 20,
                            bottom: 20,
                            left: 20
                        }
                    },
                    animation: { duration: 1000, easing: 'easeOutQuart' }
                }
            });
        }
        
        function updateChart() {
            if (stockChart) {
                stockChart.resize();
            }
        }

        function simulatePriceUpdate() {
            for (const stock of stocksList) {
                if (!stockData[stock]) {
                    stockData[stock] = {
                        prices: [Math.floor(Math.random() * 200) + 100],
                        labels: [new Date().toLocaleTimeString()]
                    };
                }
                const lastPrice = stockData[stock].prices[stockData[stock].prices.length - 1];
                const change = (Math.random() - 0.5) * 5;
                const newPrice = Math.max(0, lastPrice + change);
                stockData[stock].prices.push(newPrice);
                stockData[stock].labels.push(new Date().toLocaleTimeString());
                if (stockData[stock].prices.length > 50) {
                    stockData[stock].prices.shift();
                    stockData[stock].labels.shift();
                }
            }
            if (stockChart && stockSelect.value && stockData[stockSelect.value]) {
                stockChart.data.labels = stockData[stockSelect.value].labels;
                stockChart.data.datasets[0].data = stockData[stockSelect.value].prices;
                stockChart.update();
            }
            renderPortfolio();
        }
        
        // Trading Terminal Logic
        window.executeTrade = function(type) {
            const stock = terminalStockSelect.value;
            const quantity = parseInt(document.getElementById('terminal-quantity').value);
            const price = stockData[stock]?.prices[stockData[stock].prices.length - 1];

            if (!stock || !quantity || quantity <= 0 || !price) {
                showMessageBox("Invalid Trade", "Please select a stock and enter a valid quantity.");
                return;
            }

            const tradeLog = (message) => {
                const p = document.createElement('p');
                p.className = "text-sm text-gray-400 mt-1";
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                tradingLog.prepend(p);
                if (tradingLog.children.length > 10) {
                    tradingLog.removeChild(tradingLog.lastChild);
                }
            };
            
            if (type === 'buy') {
                const totalCost = quantity * price;
                if (cashBalance >= totalCost) {
                    portfolio[stock] = (portfolio[stock] || 0) + quantity;
                    cashBalance -= totalCost;
                    tradeLog(`BUY ${quantity} shares of ${stock} at $${price.toFixed(2)}.`);
                    saveUserDataToFirestore();
                } else {
                    showMessageBox("Trade Failed", `You do not have enough cash to buy ${quantity} shares of ${stock}.`);
                    tradeLog(`FAILED BUY: Insufficient cash.`);
                }
            } else if (type === 'sell') {
                if (!portfolio[stock] || portfolio[stock] < quantity) {
                    showMessageBox("Trade Failed", `You do not have enough shares of ${stock} to sell.`);
                    tradeLog(`FAILED SELL: Not enough shares of ${stock}.`);
                } else {
                    portfolio[stock] -= quantity;
                    cashBalance += quantity * price;
                    if (portfolio[stock] === 0) {
                        delete portfolio[stock];
                    }
                    tradeLog(`SELL ${quantity} shares of ${stock} at $${price.toFixed(2)}.`);
                    saveUserDataToFirestore();
                }
            }
        }

        // Tor Browser logic
        window.loadTorPage = function() {
            const urlInput = document.getElementById('tor-url-input');
            const iframe = document.getElementById('tor-iframe');
            let url = urlInput.value.trim();
            if (!url) {
                showMessageBox("Invalid URL", "Please enter a URL.");
                return;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            iframe.src = url;
        }
        
        // Portfolio Manager Logic
        function renderPortfolio() {
            const tableBody = document.getElementById('portfolio-table-body');
            tableBody.innerHTML = '';
            for (const stock in portfolio) {
                const quantity = portfolio[stock];
                if (quantity === 0) continue;
                const lastPrice = stockData[stock] ? stockData[stock].prices[stockData[stock].prices.length - 1] : 0;
                const value = lastPrice * quantity;
                const row = document.createElement('tr');
                row.className = "border-b border-gray-700 hover:bg-gray-700 transition-colors";
                row.innerHTML = `
                    <td class="py-2">${stock}</td>
                    <td class="py-2">${quantity}</td>
                    <td class="py-2">$${lastPrice.toFixed(2)}</td>
                    <td class="py-2">$${value.toFixed(2)}</td>
                    <td class="py-2"><button onclick="removeStockFromPortfolio('${stock}')" class="px-3 py-1 bg-red-600 rounded-md text-sm hover:bg-red-700">Remove</button></td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        window.removeStockFromPortfolio = function(stock) {
            delete portfolio[stock];
            renderPortfolio();
            saveUserDataToFirestore();
        }

        function saveUserDataToFirestore() {
            if (!userId) {
                console.error("User ID not available, cannot save data.");
                return;
            }
            const docRef = doc(db, "artifacts", appId, "users", userId, "settings", "userData");
            setDoc(docRef, { 
                portfolio: portfolio,
                cashBalance: cashBalance
            }).then(() => {
                console.log("User data saved to Firestore.");
            }).catch(error => {
                console.error("Error saving user data:", error);
            });
        }
        
        // News Feed Logic
        function updateNewsFeed() {
            const newsItem = document.createElement('div');
            const headline = newsHeadlines[Math.floor(Math.random() * newsHeadlines.length)];
            const time = new Date().toLocaleTimeString();
            newsItem.className = "bg-[#2d3748] p-3 rounded-lg flex items-center justify-between";
            newsItem.innerHTML = `
                <p class="text-sm">${headline}</p>
                <span class="text-xs text-gray-400 whitespace-nowrap">${time}</span>
            `;
            newsFeed.prepend(newsItem);
            if (newsFeed.children.length > 20) {
                    newsFeed.removeChild(newsFeed.lastChild);
            }
        }

        // Calculator Logic
        function updateCalcDisplay() {
            document.getElementById('calc-display').textContent = currentCalcInput;
        }

        window.appendNumber = function(num) {
            if (currentCalcInput === '0' && num !== '.') {
                currentCalcInput = num;
            } else if (currentCalcInput.includes('.') && num === '.') {
                return;
            } else {
                currentCalcInput += num;
            }
            updateCalcDisplay();
        }

        window.appendOperator = function(op) {
            if (currentCalcInput !== '0') {
                previousCalcInput = currentCalcInput;
                currentOperator = op;
                currentCalcInput = '0';
            }
        }

        window.calculateResult = function() {
            if (previousCalcInput && currentOperator) {
                let result;
                const prev = parseFloat(previousCalcInput);
                const current = parseFloat(currentCalcInput);
                if (current === 0 && currentOperator === '/') {
                    showMessageBox("Error", "Division by zero is not allowed.");
                    currentCalcInput = '0';
                    return;
                }
                switch(currentOperator) {
                    case '+': result = prev + current; break;
                    case '-': result = prev - current; break;
                    case '*': result = prev * current; break;
                    case '/': result = prev / current; break;
                }
                currentCalcInput = result.toString();
                previousCalcInput = '';
                currentOperator = null;
                updateCalcDisplay();
            }
        }

        window.clearCalc = function() {
            currentCalcInput = '0';
            previousCalcInput = '';
            currentOperator = null;
            updateCalcDisplay();
        }
        
        window.onload = function() {
            // Firebase setup
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                (async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser.uid;
                        console.log("Authenticated with Firebase. User ID:", userId);
                        
                        // Listen for changes in the user's data
                        const userDocRef = doc(db, "artifacts", appId, "users", userId, "settings", "userData");
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                portfolio = data.portfolio || {};
                                cashBalance = data.cashBalance || 10000;
                                renderPortfolio();
                                cashBalanceEl.textContent = `$${cashBalance.toFixed(2)}`;
                            } else {
                                // Set initial data if document doesn't exist
                                setDoc(userDocRef, {
                                    portfolio: {},
                                    cashBalance: 10000
                                });
                            }
                        }, (error) => {
                            console.error("Error fetching user data:", error);
                        });

                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showMessageBox("Authentication Error", "Failed to authenticate with Firebase. Please check your configuration.");
                    }
                })();
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showMessageBox("Configuration Error", "Firebase configuration is missing or invalid. Please check the `__firebase_config` variable.");
            }

            // OS boot sequence
            const bootProgress = document.getElementById('boot-progress');
            let progress = 0;
            const bootInterval = setInterval(() => {
                progress += 10;
                bootProgress.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(bootInterval);
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.opacity = '0';
                        document.getElementById('boot-screen').style.pointerEvents = 'none';
                        document.getElementById('desktop').classList.remove('hidden');
                        document.getElementById('taskbar').classList.remove('hidden');
                        document.getElementById('stock-os-title').style.opacity = '0';
                        document.getElementById('boot-audio').play().catch(e => console.error("Audio playback failed:", e));
                        initializeOS();
                    }, 500);
                }
            }, 100);
        };

        function initializeOS() {
            // Populate stock select dropdowns
            stocksList.forEach(stock => {
                const option1 = document.createElement('option');
                option1.value = stock;
                option1.textContent = stock;
                stockSelect.appendChild(option1);

                const option3 = document.createElement('option');
                option3.value = stock;
                option3.textContent = stock;
                terminalStockSelect.appendChild(option3);
            });

            // Initial chart setup
            simulatePriceUpdate(); // Initialize prices for all stocks
            stockSelect.value = 'AAPL';
            createChart('AAPL');

            // Handle stock selection change
            stockSelect.addEventListener('change', () => {
                createChart(stockSelect.value);
            });

            // News Feed and Stock Update intervals
            setInterval(updateNewsFeed, 5000);
            setInterval(simulatePriceUpdate, 3000);

            // Window initialization
            registerWindow('stock-chart-window');
            registerWindow('trading-terminal-window');
            registerWindow('tor-browser-window');
            registerWindow('portfolio-window');
            registerWindow('news-window');
            registerWindow('calculator-window');
        }
    </script>
</body>
</html>